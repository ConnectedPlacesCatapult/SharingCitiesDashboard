box: fccsharingcities/sharingcitiesdashboard
build:
  steps:
    - script:
        name: Basic Information
        code: |
          python -V
    - script:
        name: Set up Postgres env variables
        code: |
          export PGHOST=$POSTGIS_PORT_5432_TCP_ADDR
          export PGPORT=$POSTGIS_PORT_5432_TCP_PORT
          export PGUSER=postgres
          export PGPASSWORD=postgres
    - script:
        name: Wait for Postgres to come up
        code: |
          while ! psql -c "\l"; do
            echo "PostgresSQL unavailable, waiting..."
            sleep 3
          done
    - script:
        name: Set up test database
        code: |
          createuser root
          createdb -O root analytics -E UTF8
    - script:
        name: Set Settings file
        code: |
          mv Analytics/settings.py.test Analytics/settings.py
    - script:
        name: Setup Database
        code: |
          python Analytics/initdb.py
          python Analytics/manage.py db init
          python Analytics/manage.py db migrate
          python Analytics/manage.py db upgrade
          python Analytics/inittb_operations.py
    - script:
        name: Run Test
        code: |
          python Analytics/run_tests.py